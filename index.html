<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Голосование: Смертная казнь</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Roboto', sans-serif;
    margin: 0;
    background: #f0f4f8;
    color: #333;
  }

  /* Навигация */
  #nav {
    display: flex;
    background-color: #2c3e50;
    overflow-x: auto;
  }
  #nav button {
    flex: 1;
    padding: 15px 0;
    background: none;
    border: none;
    color: #ecf0f1;
    font-size: 17px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
  }
  #nav button:hover {
    background: #34495e;
  }
  #nav button.active {
    background: #ecf0f1;
    color: #2c3e50;
    font-weight: bold;
    box-shadow: inset 0 -4px 0 #27ae60;
  }

  #mainContainer {
    max-width: 1200px;
    margin: 25px auto;
    padding: 0 15px;
  }

  /* Вкладки */
  .tab {
    display: none;
  }
  .tab.active {
    display: block;
  }

  h1 {
    text-align: center;
    margin-bottom: 25px;
    color: #2c3e50;
  }

  /* Голосование */
  #voteButtons {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    margin: 10px 0;
  }
  #voteButtons button {
    font-size: 20px;
    padding: 15px 30px;
    margin: 10px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.2s ease;
  }
  #voteButtons button:hover {
    transform: scale(1.1);
  }
  #yesBtn {
    background-color: #27ae60;
    color: #fff;
  }
  #noBtn {
    background-color: #c0392b;
    color: #fff;
  }

  /* Итоги голосования */
  #resultsContent {
    max-width: 800px;
    margin: 0 auto;
  }
  .resultLine {
    margin-bottom: 20px;
  }
  .label {
    font-weight: bold;
    margin-bottom: 8px;
  }
  .progressBar {
    background: #bdc3c7;
    border-radius: 20px;
    height: 30px;
    width: 100%;
    overflow: hidden;
  }
  .fillYes {
    background-color: #27ae60;
    height: 100%;
    width: 0%;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    color: #fff;
    padding-right: 10px;
    transition: width 1s;
  }
  .fillNo {
    background-color: #c0392b;
    height: 100%;
    width: 0%;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    color: #fff;
    padding-right: 10px;
    transition: width 1s;
  }

  /* О сайте */
  #about {
    max-width: 800px;
    margin: 0 auto;
    line-height: 1.6;
  }

</style>
</head>
<body>

<!-- Навигация по вкладкам -->
<div id="nav">
  <button class="active" data-tab="vote">Голосование</button>
  <button data-tab="results">Итоги</button>
  <button data-tab="about">О сайте</button>
</div>

<!-- Основное содержимое -->
<div id="mainContainer">
  
  <!-- Голосование -->
  <div id="vote" class="tab active">
    <h1>Должна ли быть введена смертная казнь?</h1>
    <div id="voteButtons">
      <button id="yesBtn">Да</button>
      <button id="noBtn">Нет</button>
    </div>
    <div id="thankYou" style="display:none; text-align:center; color:#2980b9; font-size:22px; margin-top:20px;">
      Спасибо за ваш голос!
    </div>
  </div>

  <!-- Итоги -->
  <div id="results" class="tab">
    <h1>Итоги голосования</h1>
    <div id="resultsContent">
      <div class="resultLine">
        <div class="label">Общее число голосов:</div>
        <div id="totalVotes">0</div>
      </div>
      <div class="resultLine">
        <div class="label">«Да» проголосовали:</div>
        <div id="yesCount">0</div>
        <div class="progressBar">
          <div class="fillYes" id="barYes">0%</div>
        </div>
      </div>
      <div class="resultLine">
        <div class="label">«Нет» проголосовали:</div>
        <div id="noCount">0</div>
        <div class="progressBar">
          <div class="fillNo" id="barNo">0%</div>
        </div>
      </div>
    </div>
  </div>

  <!-- О сайте -->
  <div id="about" class="tab">
    <h1>О сайте</h1>
    <div id="aboutText" style="max-width: 800px; margin: 0 auto; line-height: 1.6;">
      <p>Этот сайт предназначен для проведения простого и наглядного голосования по теме смертной казни.</p>
      <p>Вы можете проголосовать во вкладке «Голосование» и посмотреть результаты — во вкладке «Итоги».</p>
      <p>Создан с использованием чистого HTML, CSS и JavaScript.</p>
    </div>
  </div>

</div>

<script>
  const API = ''; // тот же хост, что и страница

  const navButtons = document.querySelectorAll('#nav button');
  const tabs = document.querySelectorAll('.tab');
  const yesBtn = document.getElementById('yesBtn');
  const noBtn = document.getElementById('noBtn');
  const thankYou = document.getElementById('thankYou');

  function getSessionId() {
    let id = localStorage.getItem('vote_session_id');
    if (!id) {
      id = 's_' + Math.random().toString(36).slice(2) + '_' + Date.now();
      localStorage.setItem('vote_session_id', id);
    }
    return id;
  }

  function setActiveTab(tabName) {
    tabs.forEach(tab => {
      tab.classList.toggle('active', tab.id === tabName);
    });
    navButtons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tabName);
    });
    updateResults();
  }

  navButtons.forEach(btn => {
    btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
  });

  function disableVoting() {
    yesBtn.style.display = 'none';
    noBtn.style.display = 'none';
    thankYou.style.display = 'block';
  }

  function applyVotedState(voted) {
    if (voted) disableVoting();
  }

  async function fetchResults() {
    const r = await fetch(API + '/api/results');
    if (!r.ok) return { yes: 0, no: 0 };
    const data = await r.json();
    return { yes: data.yes || 0, no: data.no || 0 };
  }

  async function updateResults() {
    const votes = await fetchResults();
    const total = votes.yes + votes.no;
    const yesPercent = total ? Math.round((votes.yes / total) * 100) : 0;
    const noPercent = total ? Math.round((votes.no / total) * 100) : 0;

    document.getElementById('totalVotes').textContent = total;
    document.getElementById('yesCount').textContent = votes.yes;
    document.getElementById('noCount').textContent = votes.no;

    const barYes = document.getElementById('barYes');
    const barNo = document.getElementById('barNo');
    barYes.style.width = yesPercent + '%';
    barYes.textContent = yesPercent + '%';
    barNo.style.width = noPercent + '%';
    barNo.textContent = noPercent + '%';
  }

  async function sendVote(choice) {
    const sessionId = getSessionId();
    const r = await fetch(API + '/api/vote', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ choice: choice, session_id: sessionId }),
    });
    const data = await r.json().catch(() => ({}));
    if (r.status === 409 && data.already_voted) {
      applyVotedState(true);
      return;
    }
    if (!r.ok) {
      alert(data.error || 'Ошибка при отправке голоса');
      return;
    }
    applyVotedState(true);
    updateResults();
  }

  yesBtn.onclick = () => sendVote('yes');
  noBtn.onclick = () => sendVote('no');

  window.addEventListener('load', async () => {
    const sessionId = getSessionId();
    try {
      const r = await fetch(API + '/api/check', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: sessionId }),
      });
      const data = await r.json().catch(() => ({}));
      if (data.voted) applyVotedState(true);
    } catch (e) {
      console.warn('Не удалось проверить голос', e);
    }
    updateResults();
  });
</script>

</body>
</html>
